<!DOCTYPE html>
<html>
<head></head>
<body>
    <video id="myVideo" style="width: 50em" controls autoplay muted></video>
    <script>
        const video = document.getElementById("myVideo");
        const mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener("sourceopen", async () => {
            const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.64001E, mp4a.40.2"');
            const socket = new WebSocket("ws://localhost:8080/ws")

            socket.addEventListener("message", (event) => {
                console.log(event.data);
            });

            const response = await fetch("http://localhost:8080/ai/text/1", {
                method: "POST",
                headers: {
                    "Content-Type": "text/plain"
                },
                body: "Was ist um 13 Uhr"
            });

            const reader = response.body.getReader();

            function readChunk() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        mediaSource.endOfStream();
                        return;
                    }
                    sourceBuffer.appendBuffer(value);

                    // Video starten, sobald der erste Chunk geladen wurde und der Buffer nicht mehr updated
                    if (!sourceBuffer.updating) {
                        video.play().catch(e => console.log("Autoplay failed:", e));
                        readChunk();
                    } else {
                        sourceBuffer.addEventListener("updateend", () => {
                            video.play().catch(e => console.log("Autoplay failed:", e));
                            readChunk();
                        }, { once: true });
                    }
                });
            }

            readChunk();
        });
    </script>
</body>
</html>